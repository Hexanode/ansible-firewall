# Generated by Ansible Firewall role

# NAT
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT

# CUSTOM RULES

## Forwarded ports
{% for forwarded_port in firewall_forwarded_tcp_ports %}
-A PREROUTING -p tcp --dport {{ forwarded_port.src }} -j REDIRECT --to-port {{ forwarded_port.dest }}
-A OUTPUT -p tcp -o lo --dport {{ forwarded_port.src }} -j REDIRECT --to-port {{ forwarded_port.dest }}
{% endfor %}
{% for forwarded_port in firewall_forwarded_udp_ports %}
-A PREROUTING -p udp --dport {{ forwarded_port.src }} -j REDIRECT --to-port {{ forwarded_port.dest }}
-A OUTPUT -p udp -o lo --dport {{ forwarded_port.src }} -j REDIRECT --to-port {{ forwarded_port.dest }}
{% endfor %}

{% for rule in firewall_ipv6_additional_nat_rules %}
{{ rule }}
{% endfor %}

# FILTER
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:LOG_DROP - [0:0]
:LOG_DROP_OUT - [0:0]

# BEGIN RULES
## Accept traffic from loopback interface
-A INPUT -i lo -m comment --comment "00000 INPUT ALL ACCEPT lo" -j ACCEPT
##Â Accept related, established traffic
-A INPUT -m comment --comment "00001 INPUT ALL RELATED,ESTABLISHED ACCEPT" -m state --state RELATED,ESTABLISHED -j ACCEPT
{% if firewall_allow_icmp %}
## Allow icmp requests
-A INPUT -p icmp -m comment --comment "00002 INPUT ICMP ACCEPT" -j ACCEPT
{% endif %}

# CUSTOM RULES

## Open ports from any
{% for port in firewall_allowed_tcp_ports %}
-A INPUT -p tcp -m tcp --dport {{ port }} -j ACCEPT
{% endfor %}
{% for port in firewall_allowed_udp_ports %}
-A INPUT -p udp -m udp --dport {{ port }} -j ACCEPT
{% endfor %}

# Additional custom rules
{% for rule in firewall_ipv6_additional_rules %}
{{ rule }}
{% endfor %}

# END RULES
{% if firewall_log_dropped_packets %}
-A INPUT -m comment --comment "99998 INPUT ALL LOG_DROP" -j LOG_DROP
-A INPUT -m comment --comment "99999 INPUT ALL DROP" -j DROP
{% elif firewall_reject_instead_of_drop %}
-A INPUT -j REJECT
{% else %}
-A INPUT -j DROP
{% endif %}

# DROP RULES
{% if firewall_log_dropped_packets %}
## LOG DROP INPUT
-A LOG_DROP -m limit --limit 10/minute -m comment --comment "00000 LOG_DROP ALL LOG" -j LOG --log-prefix "[IPT DROP]: "
-A LOG_DROP -m limit --limit 10/minute -m comment --comment "00001 LOG_DROP ALL DROP" -j DROP
## LOG DROP OUTPUT
-A LOG_DROP_OUT -m limit --limit 10/minute -m comment --comment "00000 LOG_DROP_OUT ALL LOG" -j LOG --log-prefix "[IPT DROP OUT]: "
-A LOG_DROP_OUT -m limit --limit 10/minute -m comment --comment "00001 LOG_DROP_OUT ALL DROP" -j DROP
{% endif %}

COMMIT
# Completed
