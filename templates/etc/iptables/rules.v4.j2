#jinja2: trim_blocks: True, lstrip_blocks: True
# Generated by Ansible Firewall Role - DO NOT EDIT

# NAT TABLE
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

## ROLES RULES

{% for role_rules in enabled_role_rules_list %}
    {%- if hostvars[inventory_hostname][role_rules] is defined -%}
        ### {{ role_rules | replace('_firewall_rules','') | upper }}
        {% for rule in hostvars[inventory_hostname][role_rules] -%}
            {% if ( rule.table is defined and rule.table|lower == 'nat' ) and
                  ( rule.ip is not defined or rule.ip == '4' ) -%}
                    -A {%- if rule.chain is defined %} {{ rule.chain }} {%- else %} INPUT {%- endif %}
                {%- if rule.in_if is defined %} -i {{ rule.in_if }} {%- endif %}
                {%- if rule.out_if is defined %} -o {{ rule.out_if }} {%- endif %}
                {%- if rule.proto is defined %} -p {{ rule.proto }} -m {{ rule.proto }} {%- endif %}
                {%- if rule.src_ip is defined and rule.src_ip != 'any' %} --source
                    {%- if rule.src_ip is search('/') %} {{ rule.src_ip }} {%- else %} {{ rule.src_ip }}/32 {%- endif %}
                {%- endif %}
                {%- if rule.src_port is defined and rule.src_port != 'any' %} --sport {{ rule.src_port }} {%- endif %}
                {%- if rule.dest_ip is defined and rule.dest_ip != 'any' %} --destination
                    {%- if rule.dest_ip is search('/') %} {{ rule.dest_ip }} {%- else %} {{ rule.dest_ip }}/32 {%- endif %}
                {%- endif %}
                {%- if rule.dest_port is defined and rule.dest_port != 'any' %} --dport {{ rule.dest_port }} {%- endif %}
                {%- if rule.comment is defined %} -m comment --comment "{{ rule.comment }}" {%- endif %}
                {%- if rule.policy is not defined %} -j ACCEPT {%- else %} -j {{ rule.policy }} {%- endif %}

            {% endif %}
        {% endfor %}
    {% endif %}

{% endfor %}
## CUSTOM RULES

### Custom rules from variables
{% if firewall_rules is defined -%}
    {% for rule in firewall_rules -%}
        {% if ( rule.table is defined and rule.table|lower == 'nat' ) and
              ( rule.ip is not defined or rule.ip == '4' ) -%}
                -A {%- if rule.chain is defined %} {{ rule.chain }} {%- else %} INPUT {%- endif %}
            {%- if rule.in_if is defined %} -i {{ rule.in_if }} {%- endif %}
            {%- if rule.out_if is defined %} -o {{ rule.out_if }} {%- endif %}
            {%- if rule.proto is defined %} -p {{ rule.proto }} -m {{ rule.proto }} {%- endif %}
            {%- if rule.src_ip is defined and rule.src_ip != 'any' %} --source
                {%- if rule.src_ip is search('/') %} {{ rule.src_ip }} {%- else %} {{ rule.src_ip }}/32 {%- endif %}
            {%- endif %}
            {%- if rule.src_port is defined and rule.src_port != 'any' %} --sport {{ rule.src_port }} {%- endif %}
            {%- if rule.dest_ip is defined and rule.dest_ip != 'any' %} --destination
                {%- if rule.dest_ip is search('/') %} {{ rule.dest_ip }} {%- else %} {{ rule.dest_ip }}/32 {%- endif %}
            {%- endif %}
            {%- if rule.dest_port is defined and rule.dest_port != 'any' %} --dport {{ rule.dest_port }} {%- endif %}
            {%- if rule.comment is defined %} -m comment --comment "{{ rule.comment }}" {%- endif %}
            {%- if rule.policy is not defined %} -j ACCEPT {%- else %} -j {{ rule.policy }} {%- endif %}

        {% endif %}
    {% endfor %}
{% endif %}

### Forwarded ports rules
{% for rule in firewall_forwarded_ports_rules %}
-A PREROUTING {%- if rule.proto is not defined %} -p tcp {%- else %} -p {{ rule.proto }} {%- endif %} --dport {{ rule.src_port }} -j REDIRECT --to-port {{ rule.dest_port }}
-A OUTPUT {%- if rule.proto is not defined %} -p tcp {%- else %} -p {{ rule.proto }} {%- endif %} -o lo --dport {{ rule.src_port }} -j REDIRECT --to-port {{ rule.dest_port }}
{% endfor %}

### Additional custom rules
{% for rule in firewall_ipv4_additional_nat_rules -%}
    {{ rule }}
{% endfor %}

COMMIT

# FILTER TABLE
*filter
:INPUT {{ 'ACCEPT' if firewall_input_policy_accept else 'DROP' }} [0:0]
:FORWARD {{ 'ACCEPT' if firewall_forward_policy_accept else 'DROP' }} [0:0]
:OUTPUT {{ 'ACCEPT' if firewall_output_policy_accept else 'DROP' }} [0:0]
:LOG_CHAIN_IN - [0:0]
:LOG_CHAIN_OUT - [0:0]

## BEGIN RULES

### Accept traffic from loopback interface
-A INPUT -i lo -m comment --comment "00000 INPUT ALL ACCEPT lo" -j ACCEPT

### Accept related, established traffic
-A INPUT -m comment --comment "00001 INPUT ALL RELATED,ESTABLISHED ACCEPT" -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

{% if firewall_allow_icmp %}
### Allow icmp requests
-A INPUT -p icmp -m comment --comment "00002 INPUT ICMP ACCEPT" -j ACCEPT
{% endif %}

## ROLES RULES

{% for role_rules in enabled_role_rules_list %}
    {%- if hostvars[inventory_hostname][role_rules] is defined -%}
        ### {{ role_rules | replace('_firewall_rules','') | upper }}
        {% for rule in hostvars[inventory_hostname][role_rules] -%}
            {% if ( rule.table is not defined or rule.table|lower == 'filter' ) and
                  ( rule.ip is not defined or rule.ip == '4' ) -%}
                    -A {%- if rule.chain is defined %} {{ rule.chain }} {%- else %} INPUT {%- endif %}
                {%- if rule.in_if is defined %} -i {{ rule.in_if }} {%- endif %}
                {%- if rule.out_if is defined %} -o {{ rule.out_if }} {%- endif %}
                {%- if rule.proto is defined %} -p {{ rule.proto }} -m {{ rule.proto }} {%- endif %}
                {%- if rule.src_ip is defined and rule.src_ip != 'any' %} --source
                    {%- if rule.src_ip is search('/') %} {{ rule.src_ip }} {%- else %} {{ rule.src_ip }}/32 {%- endif %}
                {%- endif %}
                {%- if rule.src_port is defined and rule.src_port != 'any' %} --sport {{ rule.src_port }} {%- endif %}
                {%- if rule.dest_ip is defined and rule.dest_ip != 'any' %} --destination
                    {%- if rule.dest_ip is search('/') %} {{ rule.dest_ip }} {%- else %} {{ rule.dest_ip }}/32 {%- endif %}
                {%- endif %}
                {%- if rule.dest_port is defined and rule.dest_port != 'any' %} --dport {{ rule.dest_port }} {%- endif %}
                {%- if rule.comment is defined %} -m comment --comment "{{ rule.comment }}" {%- endif %}
                {%- if rule.policy is not defined %} -j ACCEPT {%- else %} -j {{ rule.policy }} {%- endif %}

            {% endif %}
        {% endfor %}
    {% endif %}

{% endfor %}
## CUSTOM RULES

### Custom rules from variables
{% if firewall_rules is defined -%}
    {% for rule in firewall_rules -%}
        {% if ( rule.table is not defined or rule.table|lower == 'filter' ) and
              ( rule.ip is not defined or rule.ip == '4' ) -%}
                -A {%- if rule.chain is defined %} {{ rule.chain }} {%- else %} INPUT {%- endif %}
            {%- if rule.in_if is defined %} -i {{ rule.in_if }} {%- endif %}
            {%- if rule.out_if is defined %} -o {{ rule.out_if }} {%- endif %}
            {%- if rule.proto is defined %} -p {{ rule.proto }} -m {{ rule.proto }} {%- endif %}
            {%- if rule.src_ip is defined and rule.src_ip != 'any' %} --source
                {%- if rule.src_ip is search('/') %} {{ rule.src_ip }} {%- else %} {{ rule.src_ip }}/32 {%- endif %}
            {%- endif %}
            {%- if rule.src_port is defined and rule.src_port != 'any' %} --sport {{ rule.src_port }} {%- endif %}
            {%- if rule.dest_ip is defined and rule.dest_ip != 'any' %} --destination
                {%- if rule.dest_ip is search('/') %} {{ rule.dest_ip }} {%- else %} {{ rule.dest_ip }}/32 {%- endif %}
            {%- endif %}
            {%- if rule.dest_port is defined and rule.dest_port != 'any' %} --dport {{ rule.dest_port }} {%- endif %}
            {%- if rule.comment is defined %} -m comment --comment "{{ rule.comment }}" {%- endif %}
            {%- if rule.policy is not defined %} -j ACCEPT {%- else %} -j {{ rule.policy }} {%- endif %}

        {% endif %}
    {% endfor %}
{% endif %}

### Additional custom rules
{% for rule in firewall_ipv4_additional_rules -%}
    {{ rule }}
{% endfor %}

## END RULES

{% if firewall_log_dropped_packets %}
-A INPUT -m comment --comment "99998 INPUT ALL LOG_CHAIN_IN" -j LOG_CHAIN_IN
{% endif %}
-A INPUT -m comment --comment "99999 INPUT ALL {{ 'DROP' if firewall_drop_instead_of_reject else 'REJECT' }}" -j {{ 'DROP' if firewall_drop_instead_of_reject else 'REJECT' }}

## DROP RULES

{% if firewall_log_dropped_packets %}
### LOG DROP INPUT
-A LOG_CHAIN_IN -m limit --limit {{ firewall_limit_log }}/min -m comment --comment "00000 LOG_CHAIN_IN ALL LOG" -j LOG --log-prefix "[IPT LOG IN]: "
-A LOG_CHAIN_IN -m comment --comment "00001 LOG_CHAIN_IN ALL {{ 'DROP' if firewall_drop_instead_of_reject else 'REJECT' }}" -j {{ 'DROP' if firewall_drop_instead_of_reject else 'REJECT' }}

### LOG DROP OUTPUT
-A LOG_CHAIN_OUT -m limit --limit {{ firewall_limit_log }}/min -m comment --comment "00000 LOG_CHAIN_OUT ALL LOG" -j LOG --log-prefix "[IPT LOG OUT]: "
-A LOG_CHAIN_OUT -m comment --comment "00001 LOG_CHAIN_OUT ALL {{ 'DROP' if firewall_drop_instead_of_reject else 'REJECT' }}" -j {{ 'DROP' if firewall_drop_instead_of_reject else 'REJECT' }}
{% endif %}

## FORWARD RULES

COMMIT

# Completed
